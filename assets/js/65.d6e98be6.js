(window.webpackJsonp=window.webpackJsonp||[]).push([[65],{482:function(s,a,n){"use strict";n.r(a);var t=n(22),e=Object(t.a)({},(function(){var s=this,a=s.$createElement,n=s._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"koa2-开始"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#koa2-开始"}},[s._v("#")]),s._v(" "),n("strong",[s._v("Koa2 开始")])]),s._v(" "),n("h3",{attrs:{id:"一、koa2-快速开始"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#一、koa2-快速开始"}},[s._v("#")]),s._v(" "),n("strong",[s._v("一、koa2 快速开始")])]),s._v(" "),n("h4",{attrs:{id:"_1、环境准备"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1、环境准备"}},[s._v("#")]),s._v(" "),n("strong",[s._v("1、环境准备")])]),s._v(" "),n("p",[n("strong",[s._v("因为node.js v7.6.0开始完全支持async/await，不需要加flag，所以node.js环境都要7.6.0以上 node.js环境 版本v7.6以上 npm 版本3.x以上")])]),s._v(" "),n("h4",{attrs:{id:"_2、快速开始"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2、快速开始"}},[s._v("#")]),s._v(" "),n("strong",[s._v("2、快速开始")])]),s._v(" "),n("h5",{attrs:{id:"_2-1-安装koa2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-安装koa2"}},[s._v("#")]),s._v(" "),n("strong",[s._v("2.1 安装koa2")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("# 初始化package.json\nnpm init\n\n# 安装koa2 \nnpm install koa\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("h5",{attrs:{id:"_2-2-hello-world-代码"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-hello-world-代码"}},[s._v("#")]),s._v(" "),n("strong",[s._v("2.2 hello world 代码")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("const Koa = require('koa')\nconst app = new Koa()\n\napp.use( async ( ctx ) => {\n  ctx.body = 'hello koa2'\n})\n\napp.listen(3000)\nconsole.log('[demo] start-quick is starting at port 3000')\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])]),n("h5",{attrs:{id:"_2-3-启动demo"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-启动demo"}},[s._v("#")]),s._v(" "),n("strong",[s._v("2.3 启动demo")])]),s._v(" "),n("p",[n("strong",[s._v("由于koa2是基于async/await操作中间件，目前node.js 7.x的harmony模式下才能使用，所以启动的时的脚本如下：")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("node index.js\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h3",{attrs:{id:"二、async-await使用"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#二、async-await使用"}},[s._v("#")]),s._v(" "),n("strong",[s._v("二、async/await使用")])]),s._v(" "),n("h4",{attrs:{id:"_1、快速上手理解"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1、快速上手理解"}},[s._v("#")]),s._v(" "),n("strong",[s._v("1、快速上手理解")])]),s._v(" "),n("p",[n("strong",[s._v("先复制以下这段代码，在粘贴在chrome的控制台console中，按回车键执行")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("function getSyncTime() {\n  return new Promise((resolve, reject) => {\n    try {\n      let startTime = new Date().getTime()\n      setTimeout(() => {\n        let endTime = new Date().getTime()\n        let data = endTime - startTime\n        resolve( data )\n      }, 500)\n    } catch ( err ) {\n      reject( err )\n    }\n  })\n}\n\nasync function getSyncData() {\n  let time = await getSyncTime()\n  let data = `endTime - startTime = ${time}`\n  return data\n}\n\nasync function getData() {\n  let data = await getSyncData()\n  console.log( data )\n}\n\ngetData()\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br")])]),n("h4",{attrs:{id:"_2、从上述例子可以看出-async-await-的特点"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2、从上述例子可以看出-async-await-的特点"}},[s._v("#")]),s._v(" "),n("strong",[s._v("2、从上述例子可以看出 async/await 的特点：")])]),s._v(" "),n("ul",[n("li",[n("strong",[s._v("可以让异步逻辑用同步写法实现")])]),s._v(" "),n("li",[n("strong",[s._v("最底层的await返回需要是Promise对象")])]),s._v(" "),n("li",[n("strong",[s._v("可以通过多层 async function 的同步写法代替传统的callback嵌套")])])]),s._v(" "),n("h3",{attrs:{id:"三、koa2简析结构"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#三、koa2简析结构"}},[s._v("#")]),s._v(" "),n("strong",[s._v("三、koa2简析结构")])]),s._v(" "),n("h4",{attrs:{id:"_1、源码文件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1、源码文件"}},[s._v("#")]),s._v(" "),n("strong",[s._v("1、源码文件")])]),s._v(" "),n("p",[n("strong",[s._v("├── lib │ ├── application.js │ ├── context.js │ ├── request.js │ └── response.js └── package.json")])]),s._v(" "),n("p",[s._v("**这个就是 GitHub **"),n("a",{attrs:{href:"https://github.com/koajs/koa",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://github.com/koajs/koa"),n("OutboundLink")],1),n("strong",[s._v("上开源的koa2源码的源文件结构，核心代码就是lib目录下的四个文件")])]),s._v(" "),n("ul",[n("li",[n("strong",[s._v("application.js 是整个koa2 的入口文件，封装了context，request，response，以及最核心的中间件处理流程。")])]),s._v(" "),n("li",[n("strong",[s._v("context.js 处理应用上下文，里面直接封装部分request.js和response.js的方法")])]),s._v(" "),n("li",[n("strong",[s._v("request.js 处理http请求")])]),s._v(" "),n("li",[n("strong",[s._v("response.js 处理http响应")])])]),s._v(" "),n("h4",{attrs:{id:"_2、koa2特性"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2、koa2特性"}},[s._v("#")]),s._v(" "),n("strong",[s._v("2、koa2特性")])]),s._v(" "),n("ul",[n("li",[n("strong",[s._v("只提供封装好http上下文、请求、响应，以及基于async/await的中间件容器。")])]),s._v(" "),n("li",[n("strong",[s._v("利用ES7的async/await的来处理传统回调嵌套问题和代替koa@1的generator，但是需要在node.js 7.x的harmony模式下才能支持async/await。")])]),s._v(" "),n("li",[n("strong",[s._v("中间件只支持 async/await 封装的，如果要使用koa@1基于generator中间件，需要通过中间件koa-convert封装一下才能使用。")])])]),s._v(" "),n("h3",{attrs:{id:"四、koa中间件开发和使用"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#四、koa中间件开发和使用"}},[s._v("#")]),s._v(" "),n("strong",[s._v("四、koa中间件开发和使用")])]),s._v(" "),n("ul",[n("li",[n("strong",[s._v("koa v1和v2中使用到的中间件的开发和使用")])]),s._v(" "),n("li",[n("strong",[s._v("generator 中间件开发在koa v1和v2中使用")])]),s._v(" "),n("li",[n("strong",[s._v("async await 中间件开发和只能在koa v2中使用")])])]),s._v(" "),n("h4",{attrs:{id:"_1、generator中间件开发"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1、generator中间件开发"}},[s._v("#")]),s._v(" "),n("strong",[s._v("1、generator中间件开发")])]),s._v(" "),n("h5",{attrs:{id:"_1-1-generator中间件开发"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-generator中间件开发"}},[s._v("#")]),s._v(" "),n("strong",[s._v("1.1 generator中间件开发")])]),s._v(" "),n("blockquote",[n("p",[n("strong",[s._v("generator中间件返回的应该是function * () 函数")])])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("/* ./middleware/logger-generator.js */\nfunction log( ctx ) {\n  console.log( ctx.method, ctx.header.host + ctx.url )\n}\n\nmodule.exports = function () {\n  return function * ( next ) {\n\n    // 执行中间件的操作\n    log( this )\n\n    if ( next ) {\n      yield next\n    }\n  }\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br")])]),n("h5",{attrs:{id:"_1-2-generator中间件在koa-1中的使用"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-generator中间件在koa-1中的使用"}},[s._v("#")]),s._v(" "),n("strong",[s._v("1.2 generator中间件在koa@1中的使用")])]),s._v(" "),n("blockquote",[n("p",[n("strong",[s._v("generator 中间件在koa v1中可以直接use使用")])])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("const koa = require('koa')  // koa v1\nconst loggerGenerator  = require('./middleware/logger-generator')\nconst app = koa()\n\napp.use(loggerGenerator())\n\napp.use(function *( ) {\n    this.body = 'hello world!'\n})\n\napp.listen(3000)\nconsole.log('the server is starting at port 3000')\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br")])]),n("h5",{attrs:{id:"_1-3-generator中间件在koa-2中的使用"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-generator中间件在koa-2中的使用"}},[s._v("#")]),s._v(" "),n("strong",[s._v("1.3 generator中间件在koa@2中的使用")])]),s._v(" "),n("blockquote",[n("p",[n("strong",[s._v("generator 中间件在koa v2中需要用koa-convert封装一下才能使用")])])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("const Koa = require('koa') // koa v2\nconst convert = require('koa-convert')\nconst loggerGenerator  = require('./middleware/logger-generator')\nconst app = new Koa()\n\napp.use(convert(loggerGenerator()))\n\napp.use(( ctx ) => {\n    ctx.body = 'hello world!'\n})\n\napp.listen(3000)\nconsole.log('the server is starting at port 3000')\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br")])]),n("h4",{attrs:{id:"_2、async中间件开发"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2、async中间件开发"}},[s._v("#")]),s._v(" "),n("strong",[s._v("2、async中间件开发")])]),s._v(" "),n("h5",{attrs:{id:"_2-1-async-中间件开发"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-async-中间件开发"}},[s._v("#")]),s._v(" "),n("strong",[s._v("2.1 async 中间件开发")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("/* ./middleware/logger-async.js */\n\nfunction log( ctx ) {\n    console.log( ctx.method, ctx.header.host + ctx.url )\n}\n\nmodule.exports = function () {\n  return async function ( ctx, next ) {\n    log(ctx);\n    await next()\n  }\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br")])]),n("h5",{attrs:{id:"_2-2-async-中间件在koa-2中使用"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-async-中间件在koa-2中使用"}},[s._v("#")]),s._v(" "),n("strong",[s._v("2.2 async 中间件在koa@2中使用")])]),s._v(" "),n("blockquote",[n("p",[n("strong",[s._v("async 中间件只能在 koa v2中使用")])])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("const Koa = require('koa') // koa v2\nconst loggerAsync  = require('./middleware/logger-async')\nconst app = new Koa()\n\napp.use(loggerAsync())\n\napp.use(( ctx ) => {\n    ctx.body = 'hello world!'\n})\n\napp.listen(3000)\nconsole.log('the server is starting at port 3000')\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br")])]),n("h1",{attrs:{id:"ii、路由"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#ii、路由"}},[s._v("#")]),s._v(" "),n("strong",[s._v("Ⅱ、路由")])]),s._v(" "),n("h3",{attrs:{id:"一、koa2-原生路由实现"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#一、koa2-原生路由实现"}},[s._v("#")]),s._v(" "),n("strong",[s._v("一、koa2 原生路由实现")])]),s._v(" "),n("h4",{attrs:{id:"_1、简单例子"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1、简单例子"}},[s._v("#")]),s._v(" "),n("strong",[s._v("1、简单例子")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("const Koa = require('koa')\nconst app = new Koa()\n\napp.use( async ( ctx ) => {\n  let url = ctx.request.url\n  ctx.body = url\n})\napp.listen(3000)\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("p",[n("strong",[s._v("访问 "),n("strong",[n("a",{attrs:{href:"http://localhost:3000/hello/world",target:"_blank",rel:"noopener noreferrer"}},[s._v("http://localhost:3000/hello/world"),n("OutboundLink")],1)]),s._v(" 页面会输出 /hello/world，也就是说上下文的请求request对象中url之就是当前访问的路径名称，可以根据ctx.request.url 通过一定的判断或者正则匹配就可以定制出所需要的路由。")])]),s._v(" "),n("h4",{attrs:{id:"_2、定制化的路由"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2、定制化的路由"}},[s._v("#")]),s._v(" "),n("strong",[s._v("2、定制化的路由")])]),s._v(" "),n("p",[n("strong",[s._v("demo源码")])]),s._v(" "),n("p",[n("a",{attrs:{href:"https://github.com/ChenShenhai/koa2-note/tree/master/demo/route-simple",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://github.com/ChenShenhai/koa2-note/tree/master/demo/route-simple"),n("OutboundLink")],1)]),s._v(" "),n("h5",{attrs:{id:"_2-1-源码文件目录"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-源码文件目录"}},[s._v("#")]),s._v(" "),n("strong",[s._v("2.1 源码文件目录")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v(".\n├── index.js\n├── package.json\n└── view\n    ├── 404.html\n    ├── index.html\n    └── todo.html\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("h5",{attrs:{id:"_2-2-demo源码"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-demo源码"}},[s._v("#")]),s._v(" "),n("strong",[s._v("2.2 demo源码")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("const Koa = require('koa')\nconst fs = require('fs')\nconst app = new Koa()\n\n/**\n * 用Promise封装异步读取文件方法\n * @param  {string} page html文件名称\n * @return {promise}    \n */\nfunction render( page ) {\n  return new Promise(( resolve, reject ) => {\n    let viewUrl = `./view/${page}`\n    fs.readFile(viewUrl, \"binary\", ( err, data ) => {\n      if ( err ) {\n        reject( err )\n      } else {\n        resolve( data )\n      }\n    })\n  })\n}\n\n/**\n * 根据URL获取HTML内容\n * @param  {string} url koa2上下文的url，ctx.url\n * @return {string}     获取HTML文件内容\n */\nasync function route( url ) {\n  let view = '404.html'\n  switch ( url ) {\n    case '/':\n      view = 'index.html'\n      break\n    case '/index':\n      view = 'index.html'\n      break\n    case '/todo':\n      view = 'todo.html'\n      break\n    case '/404':\n      view = '404.html'\n      break\n    default:\n      break\n  }\n  let html = await render( view )\n  return html\n}\n\napp.use( async ( ctx ) => {\n  let url = ctx.request.url\n  let html = await route( url )\n  ctx.body = html\n})\n\napp.listen(3000)\nconsole.log('[demo] route-simple is starting at port 3000')\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br")])]),n("h5",{attrs:{id:"_2-3-运行demo"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-运行demo"}},[s._v("#")]),s._v(" "),n("strong",[s._v("2.3 运行demo")])]),s._v(" "),n("p",[n("strong",[n("strong",[s._v("执行运行脚本")])])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("node -harmony index.js\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h3",{attrs:{id:"二、koa-router中间件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#二、koa-router中间件"}},[s._v("#")]),s._v(" "),n("strong",[s._v("二、koa-router中间件")])]),s._v(" "),n("p",[n("strong",[s._v("如果依靠ctx.request.url去手动处理路由，将会写很多处理代码，这时候就需要对应的路由的中间件对路由进行控制，这里介绍一个比较好用的路由中间件koa-router")])]),s._v(" "),n("h4",{attrs:{id:"_1、安装koa-router中间件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1、安装koa-router中间件"}},[s._v("#")]),s._v(" "),n("strong",[s._v("1、安装koa-router中间件")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("# koa2 对应的版本是 7.x\nnpm install --save koa-router@7\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("h4",{attrs:{id:"_2、快速使用koa-router"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2、快速使用koa-router"}},[s._v("#")]),s._v(" "),n("strong",[s._v("2、快速使用koa-router")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("const Koa = require('koa')\nconst fs = require('fs')\nconst app = new Koa()\n\nconst Router = require('koa-router')\n\nlet home = new Router()\n\n// 子路由1\nhome.get('/', async ( ctx )=>{\n  let html = `\n    <ul>\n      <li><a href=\"/page/helloworld\">/page/helloworld</a></li>\n      <li><a href=\"/page/404\">/page/404</a></li>\n    </ul>\n  `\n  ctx.body = html\n})\n\n// 子路由2\nlet page = new Router()\npage.get('/404', async ( ctx )=>{\n  ctx.body = '404 page!'\n}).get('/helloworld', async ( ctx )=>{\n  ctx.body = 'helloworld page!'\n})\n\n// 装载所有子路由\nlet router = new Router()\nrouter.use('/', home.routes(), home.allowedMethods())\nrouter.use('/page', page.routes(), page.allowedMethods())\n\n// 加载路由中间件\napp.use(router.routes()).use(router.allowedMethods())\n\napp.listen(3000, () => {\n  console.log('[demo] route-use-middleware is starting at port 3000')\n})\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br")])]),n("h1",{attrs:{id:"iii、请求数据获取"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#iii、请求数据获取"}},[s._v("#")]),s._v(" "),n("strong",[s._v("Ⅲ、请求数据获取")])]),s._v(" "),n("h3",{attrs:{id:"一、get请求数据获取"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#一、get请求数据获取"}},[s._v("#")]),s._v(" "),n("strong",[s._v("一、GET请求数据获取")])]),s._v(" "),n("h4",{attrs:{id:"_1、使用方法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1、使用方法"}},[s._v("#")]),s._v(" "),n("strong",[s._v("1、使用方法")])]),s._v(" "),n("p",[n("strong",[s._v("在koa中，获取GET请求数据源头是koa中request对象中的query方法或querystring方法，query返回是格式化好的参数对象，querystring返回的是请求字符串，由于ctx对request的API有直接引用的方式，所以获取GET请求数据有两个途径。")])]),s._v(" "),n("ul",[n("li",[n("strong",[s._v("是从上下文中直接获取 请求对象ctx.query，返回如 { a:1, b:2 } 请求字符串 ctx.querystring，返回如 a=1&b=2")])]),s._v(" "),n("li",[n("strong",[s._v("是从上下文的request对象中获取 请求对象ctx.request.query，返回如 { a:1, b:2 } 请求字符串 ctx.request.querystring，返回如 a=1&b=2")])])]),s._v(" "),n("h4",{attrs:{id:"_2、举个例子"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2、举个例子"}},[s._v("#")]),s._v(" "),n("strong",[s._v("2、举个例子")])]),s._v(" "),n("h5",{attrs:{id:"_2-1-例子代码"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-例子代码"}},[s._v("#")]),s._v(" "),n("strong",[s._v("2.1 例子代码")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("const Koa = require('koa')\nconst app = new Koa()\n\napp.use( async ( ctx ) => {\n  let url = ctx.url\n  // 从上下文的request对象中获取\n  let request = ctx.request\n  let req_query = request.query\n  let req_querystring = request.querystring\n\n  // 从上下文中直接获取\n  let ctx_query = ctx.query\n  let ctx_querystring = ctx.querystring\n\n  ctx.body = {\n    url,\n    req_query,\n    req_querystring,\n    ctx_query,\n    ctx_querystring\n  }\n})\n\napp.listen(3000, () => {\n  console.log('[demo] request get is starting at port 3000')\n})\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br")])]),n("h5",{attrs:{id:"_2-2-执行程序"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-执行程序"}},[s._v("#")]),s._v(" "),n("strong",[s._v("2.2 执行程序")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("node get.js\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h3",{attrs:{id:"二、post请求参数获取"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#二、post请求参数获取"}},[s._v("#")]),s._v(" "),n("strong",[s._v("二、POST请求参数获取")])]),s._v(" "),n("h4",{attrs:{id:"_1、原理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1、原理"}},[s._v("#")]),s._v(" "),n("strong",[s._v("1、原理")])]),s._v(" "),n("p",[n("strong",[s._v('对于POST请求的处理，koa2没有封装获取参数的方法，需要通过解析上下文context中的原生node.js请求对象req，将POST表单数据解析成query string（例如：a=1&b=2&c=3），再将query string 解析成JSON格式（例如：{"a":"1", "b":"2", "c":"3"}）')])]),s._v(" "),n("blockquote",[n("p",[n("strong",[s._v("注意：ctx.request是context经过封装的请求对象，ctx.req是context提供的node.js原生HTTP请求对象，同理ctx.response是context经过封装的响应对象，ctx.res是context提供的node.js原生HTTP请求对象。")])])]),s._v(" "),n("h5",{attrs:{id:"解析出post请求上下文中的表单数据"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#解析出post请求上下文中的表单数据"}},[s._v("#")]),s._v(" "),n("strong",[s._v("解析出POST请求上下文中的表单数据")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("// 解析上下文里node原生请求的POST参数\nfunction parsePostData( ctx ) {\n  return new Promise((resolve, reject) => {\n    try {\n      let postdata = \"\";\n      ctx.req.addListener('data', (data) => {\n        postdata += data\n      })\n      ctx.req.addListener(\"end\",function(){\n        let parseData = parseQueryStr( postdata )\n        resolve( parseData )\n      })\n    } catch ( err ) {\n      reject(err)\n    }\n  })\n}\n\n// 将POST请求参数字符串解析成JSON\nfunction parseQueryStr( queryStr ) {\n  let queryData = {}\n  let queryStrList = queryStr.split('&')\n  console.log( queryStrList )\n  for (  let [ index, queryStr ] of queryStrList.entries()  ) {\n    let itemList = queryStr.split('=')\n    queryData[ itemList[0] ] = decodeURIComponent(itemList[1])\n  }\n  return queryData\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br")])]),n("h4",{attrs:{id:"_2、举个例子-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2、举个例子-2"}},[s._v("#")]),s._v(" "),n("strong",[s._v("2、举个例子")])]),s._v(" "),n("h5",{attrs:{id:"_2-1-例子代码-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-例子代码-2"}},[s._v("#")]),s._v(" "),n("strong",[s._v("2.1 例子代码")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("const Koa = require('koa')\nconst app = new Koa()\n\napp.use( async ( ctx ) => {\n\n  if ( ctx.url === '/' && ctx.method === 'GET' ) {\n    // 当GET请求时候返回表单页面\n    let html = `\n      <h1>koa2 request post demo</h1>\n      <form method=\"POST\" action=\"/\">\n        <p>userName</p>\n        <input name=\"userName\" /><br/>\n        <p>nickName</p>\n        <input name=\"nickName\" /><br/>\n        <p>email</p>\n        <input name=\"email\" /><br/>\n        <button type=\"submit\">submit</button>\n      </form>\n    `\n    ctx.body = html\n  } else if ( ctx.url === '/' && ctx.method === 'POST' ) {\n    // 当POST请求的时候，解析POST表单里的数据，并显示出来\n    let postData = await parsePostData( ctx )\n    ctx.body = postData\n  } else {\n    // 其他请求显示404\n    ctx.body = '<h1>404！！！ o(╯□╰)o</h1>'\n  }\n})\n\n// 解析上下文里node原生请求的POST参数\nfunction parsePostData( ctx ) {\n  return new Promise((resolve, reject) => {\n    try {\n      let postdata = \"\";\n      ctx.req.addListener('data', (data) => {\n        postdata += data\n      })\n      ctx.req.addListener(\"end\",function(){\n        let parseData = parseQueryStr( postdata )\n        resolve( parseData )\n      })\n    } catch ( err ) {\n      reject(err)\n    }\n  })\n}\n\n// 将POST请求参数字符串解析成JSON\nfunction parseQueryStr( queryStr ) {\n  let queryData = {}\n  let queryStrList = queryStr.split('&')\n  console.log( queryStrList )\n  for (  let [ index, queryStr ] of queryStrList.entries()  ) {\n    let itemList = queryStr.split('=')\n    queryData[ itemList[0] ] = decodeURIComponent(itemList[1])\n  }\n  return queryData\n}\n\napp.listen(3000, () => {\n  console.log('[demo] request post is starting at port 3000')\n})\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br"),n("span",{staticClass:"line-number"},[s._v("63")]),n("br")])]),n("h5",{attrs:{id:"_2-2-启动例子"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-启动例子"}},[s._v("#")]),s._v(" "),n("strong",[s._v("2.2 启动例子")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("node post.js\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h3",{attrs:{id:"三、koa-bodyparser中间件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#三、koa-bodyparser中间件"}},[s._v("#")]),s._v(" "),n("strong",[s._v("三、koa-bodyparser中间件")])]),s._v(" "),n("h4",{attrs:{id:"_1、原理-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1、原理-2"}},[s._v("#")]),s._v(" "),n("strong",[s._v("1、原理")])]),s._v(" "),n("p",[n("strong",[s._v("对于POST请求的处理，koa-bodyparser中间件可以把koa2上下文的formData数据解析到ctx.request.body中")])]),s._v(" "),n("h5",{attrs:{id:"安装koa2版本的koa-bodyparser-3中间件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#安装koa2版本的koa-bodyparser-3中间件"}},[s._v("#")]),s._v(" "),n("strong",[s._v("安装koa2版本的koa-bodyparser@3中间件")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("npm install --save koa-bodyparser@3\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h4",{attrs:{id:"_2、举个例子-3"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2、举个例子-3"}},[s._v("#")]),s._v(" "),n("strong",[s._v("2、举个例子")])]),s._v(" "),n("h5",{attrs:{id:"_2-1-例子代码-3"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-例子代码-3"}},[s._v("#")]),s._v(" "),n("strong",[s._v("2.1 例子代码")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("const Koa = require('koa')\nconst app = new Koa()\nconst bodyParser = require('koa-bodyparser')\n\n// 使用ctx.body解析中间件\napp.use(bodyParser())\n\napp.use( async ( ctx ) => {\n\n  if ( ctx.url === '/' && ctx.method === 'GET' ) {\n    // 当GET请求时候返回表单页面\n    let html = `\n      <h1>koa2 request post demo</h1>\n      <form method=\"POST\" action=\"/\">\n        <p>userName</p>\n        <input name=\"userName\" /><br/>\n        <p>nickName</p>\n        <input name=\"nickName\" /><br/>\n        <p>email</p>\n        <input name=\"email\" /><br/>\n        <button type=\"submit\">submit</button>\n      </form>\n    `\n    ctx.body = html\n  } else if ( ctx.url === '/' && ctx.method === 'POST' ) {\n    // 当POST请求的时候，中间件koa-bodyparser解析POST表单里的数据，并显示出来\n    let postData = ctx.request.body\n    ctx.body = postData\n  } else {\n    // 其他请求显示404\n    ctx.body = '<h1>404！！！ o(╯□╰)o</h1>'\n  }\n})\n\napp.listen(3000, () => {\n  console.log('[demo] request post is starting at port 3000')\n})\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br")])]),n("h5",{attrs:{id:"_2-2-启动例子-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-启动例子-2"}},[s._v("#")]),s._v(" "),n("strong",[s._v("2.2 启动例子")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("node post-middleware.js\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h1",{attrs:{id:"iv、静态资源加载"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#iv、静态资源加载"}},[s._v("#")]),s._v(" "),n("strong",[s._v("Ⅳ、静态资源加载")])]),s._v(" "),n("h3",{attrs:{id:"koa-static中间件使用"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#koa-static中间件使用"}},[s._v("#")]),s._v(" "),n("strong",[s._v("koa-static中间件使用")])]),s._v(" "),n("h4",{attrs:{id:"_1、使用例子"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1、使用例子"}},[s._v("#")]),s._v(" "),n("strong",[s._v("1、使用例子")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("const Koa = require('koa')\nconst path = require('path')\nconst static = require('koa-static')\n\nconst app = new Koa()\n\n// 静态资源目录对于相对入口文件index.js的路径\nconst staticPath = './static'\n\napp.use(static(\n  path.join( __dirname,  staticPath)\n))\n\n\napp.use( async ( ctx ) => {\n  ctx.body = 'hello world'\n})\n\napp.listen(3000, () => {\n  console.log('[demo] static-use-middleware is starting at port 3000')\n})\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br")])]),n("h1",{attrs:{id:"v、模板引擎"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#v、模板引擎"}},[s._v("#")]),s._v(" "),n("strong",[s._v("Ⅴ、模板引擎")])]),s._v(" "),n("h3",{attrs:{id:"koa2加载模板引擎"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#koa2加载模板引擎"}},[s._v("#")]),s._v(" "),n("strong",[s._v("koa2加载模板引擎")])]),s._v(" "),n("h4",{attrs:{id:"_1、快速开始"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1、快速开始"}},[s._v("#")]),s._v(" "),n("strong",[s._v("1、快速开始")])]),s._v(" "),n("h5",{attrs:{id:"_1-1-安装模块"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-安装模块"}},[s._v("#")]),s._v(" "),n("strong",[s._v("1.1 安装模块")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("# 安装koa模板使用中间件\nnpm install --save koa-views\n\n# 安装ejs模板引擎\nnpm install --save ejs\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("h5",{attrs:{id:"_1-2-使用模板引擎"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-使用模板引擎"}},[s._v("#")]),s._v(" "),n("strong",[s._v("1.2 使用模板引擎")])]),s._v(" "),n("p",[n("strong",[n("strong",[s._v("文件目录")])])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("├── package.json\n├── index.js\n└── view\n    └── index.ejs\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[n("strong",[n("strong",[s._v("./index.js文件")])])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("const Koa = require('koa')\nconst views = require('koa-views')\nconst path = require('path')\nconst app = new Koa()\n\n// 加载模板引擎\napp.use(views(path.join(__dirname, './view'), {\n  extension: 'ejs'\n}))\n\napp.use( async ( ctx ) => {\n  let title = 'hello koa2'\n  await ctx.render('index', {\n    title,\n  })\n})\n\napp.listen(3000)\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br")])]),n("p",[n("strong",[n("strong",[s._v("./view/index.ejs 模板")])])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("<!DOCTYPE html>\n<html>\n<head>\n    <title><%= title %></title>\n</head>\n<body>\n    <h1><%= title %></h1>\n    <p>EJS Welcome to <%= title %></p>\n</body>\n</html>\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])])])}),[],!1,null,null,null);a.default=e.exports}}]);